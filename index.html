<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Edge Machine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-950 text-gray-100 min-h-screen font-sans">
  <div class="max-w-5xl mx-auto px-4 py-8">

    <div class="flex items-center justify-between mb-8">
      <h1 class="text-3xl font-bold">Edge Machine</h1>
      <button id="refresh"
        class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded transition">
        Refresh
      </button>
    </div>

    <div id="status" class="mb-6 text-lg font-medium">
      Loading…
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-sm border-collapse">
        <thead>
          <tr class="bg-gray-800">
            <th class="p-3 text-left">Event</th>
            <th class="p-3 text-left">Crowd (PM)</th>
            <th class="p-3 text-left">Machine</th>
            <th class="p-3 text-left">Signal</th>
          </tr>
        </thead>
        <tbody id="table"></tbody>
      </table>
    </div>

    <div id="error" class="mt-6 text-red-400 hidden"></div>

  </div>

<script>
  // ✅ LIVE RAILWAY API
  const API = "https://edge-machine-production.up.railway.app";

  async function load() {
    const status = document.getElementById("status");
    const table = document.getElementById("table");
    const error = document.getElementById("error");

    error.classList.add("hidden");
    table.innerHTML = "";
    status.textContent = "Loading markets…";

    try {
      const res = await fetch(API + "/v1/events?limit=10");
      if (!res.ok) throw new Error("API error " + res.status);

      const data = await res.json();

      if (!data.length) {
        status.textContent = "No events yet — backend alive, waiting for bootstrap";
        return;
      }

      data.forEach(e => {
        const crowd = e.latest_pm_p != null
          ? (e.latest_pm_p * 100).toFixed(1) + "%"
          : "—";

        const machine = e.latest_machine_p != null
          ? (e.latest_machine_p * 100).toFixed(1) + "%"
          : "—";

        const fade = e.latest_pm_p != null && e.latest_machine_p != null
          && e.latest_pm_p > e.latest_machine_p;

        const signal = fade ? "FADE YES" : "RIDE YES";
        const color = fade ? "text-red-400" : "text-emerald-400";

        const row = document.createElement("tr");
        row.className = "border-b border-gray-800";
        row.innerHTML = `
          <td class="p-3">${e.title}</td>
          <td class="p-3">${crowd}</td>
          <td class="p-3">${machine}</td>
          <td class="p-3 font-bold ${color}">${signal}</td>
        `;
        table.appendChild(row);
      });

      status.textContent = "Live";

    } catch (err) {
      status.textContent = "Error connecting";
      error.textContent = err.message;
      error.classList.remove("hidden");
    }
  }

  document.getElementById("refresh").onclick = load;
  load();
  setInterval(load, 30000);
</script>

</body>
</html>